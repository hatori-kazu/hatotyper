name: Build debug APK

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build debug APK

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17 (needed for sdkmanager)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle user home
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/.gradle-build-action
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*','**/build.gradle*','**/settings.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Android SDK components
        uses: actions/cache@v4
        id: cache-android-sdk
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}/platforms
            ${{ env.ANDROID_SDK_ROOT }}/build-tools
            ${{ env.ANDROID_SDK_ROOT }}/platform-tools
            ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools
          key: ${{ runner.os }}-androidsdk-${{ hashFiles('**/build.gradle*','**/app/build.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-androidsdk-

      - name: Install Android SDK components (if missing)
        shell: bash
        run: |
          set -euo pipefail
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          # If platforms/android-33 is present, skip install (cache hit or preinstalled)
          if [ -d "${ANDROID_SDK_ROOT}/platforms/android-33" ] && [ -d "${ANDROID_SDK_ROOT}/build-tools/33.0.2" ]; then
            echo "Android SDK components already present (cached or preinstalled). Skipping installation."
          else
            echo "Installing minimal Android SDK components..."
            # find sdkmanager (from runner or SDK)
            if command -v sdkmanager >/dev/null 2>&1; then
              SDKMANAGER="$(command -v sdkmanager)"
            elif [ -x "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" ]; then
              SDKMANAGER="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager"
            elif [ -x "${ANDROID_SDK_ROOT}/cmdline-tools/bin/sdkmanager" ]; then
              SDKMANAGER="${ANDROID_SDK_ROOT}/cmdline-tools/bin/sdkmanager"
            else
              SDKMANAGER=""
            fi

            if [ -n "$SDKMANAGER" ]; then
              echo "sdkmanager found at: $SDKMANAGER"
              # Accept licenses and install minimal required SDK components for compileSdk 33
              yes | "$SDKMANAGER" --sdk_root="${ANDROID_SDK_ROOT}" "platform-tools" "platforms;android-33" "build-tools;33.0.2"
              yes | "$SDKMANAGER" --sdk_root="${ANDROID_SDK_ROOT}" --licenses || true
            else
              echo "sdkmanager not found â€” cannot install Android SDK components. If build fails, provide SDK or include cmdline-tools in runner image."
            fi
          fi

      - name: Add Android SDK tools to PATH
        run: |
          echo "PATH update"
          echo "${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/build-tools/33.0.2" >> $GITHUB_PATH

      - name: Build with Gradle (no wrapper required)
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: '8.4'
          arguments: clean assembleDebug
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: hatotyper-debug-apk
          path: app/build/outputs/apk/debug/*.apk
